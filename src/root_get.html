<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Enarx Demo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
</head>

<body>
    <nav class="navbar is-light" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://enarx.dev">
                <img
                    src="https://raw.githubusercontent.com/enarx/website/main/static/assets/images/enarx-word-black-300x750.png">
            </a>

            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false"
                data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>

        <div id="navbarBasicExample" class="navbar-menu">
            <div class="navbar-start">
                <a class="navbar-item" style="font-weight: 700;">
                    Enarx Demo
                </a>
            </div>

            <div class="navbar-end">
                <div class="navbar-item">
                    <div class="buttons">
                        <a class="button is-primary" id="auth" href="/login">
                            Log in
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <section class="section">
        <div class="container">

            <article class="message is-warning" id="warning_message" style="display: none">
                <div class="message-header">
                    <p>Warning</p>
                    <button class="delete" aria-label="delete"></button>
                </div>
                <div id="message-body" class="message-body">
                    <span id="message"></span>
                </div>
            </article>

            <div class="content">
                <h3>Enarx Demo - Secured by <a href="https://www.profian.com">Profian</a></h3>
                <p>Run a Wasm payload in an Enarx Keep. Learn more from <a href="https://enarx.dev/">Enarx.dev</a> and
                    star us on <a href="https://github.com/enarx/enarx">GitHub</a>.</p>
            </div>

            <form enctype="multipart/form-data" method="post">
                <div id="upload_file" class="file has-name">
                    <label class="file-label">
                        <input class="file-input" type="file" name="wasm" accept="application/wasm">
                        <span class="file-cta">
                            <span class="file-icon">
                                <i class="fas fa-upload"></i>
                            </span>
                            <span class="file-label">
                                Choose a Wasm fileâ€¦
                            </span>
                        </span>
                        <span class="file-name">
                            No file uploaded
                        </span>
                    </label>
                </div>
                <input id="upload_submit" type="submit" class="button" value="Deploy Wasm workload" />
                <br />
                <br />
                <a href="https://enarx.dev/docs/running/enarx_toml">Enarx.toml</a>:
                <textarea class="textarea" name="toml" autofocus></textarea>
                <br />
            </form>
        </div>
    </section>
    <script>
        function httpGetAsync(theUrl, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                    callback(xmlHttp.responseText);
            }
            xmlHttp.open("GET", theUrl, true); // true for asynchronous 
            xmlHttp.send(null);
        }

        var authenticated = document.cookie.indexOf("SESSION") !== -1;

        var fileInput = document.querySelector('#upload_file input[type=file]');

        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                var fileName = document.querySelector('#upload_file .file-name');
                fileName.textContent = fileInput.files[0].name;
            }
        }

        var queryParams = new URLSearchParams(window.location.search);
        var messageCode = queryParams.get('message');
        var messageHTML = [];
        var warningMessage = window.document.getElementById("warning_message");
        var messageDiv = window.document.getElementById("message");

        // SECURITY: Do not put query parameter values in messageHTML.
        switch (messageCode) {
            case 'no_session': {
                if (!authenticated) {
                    messageHTML.push("It looks like you have been logged out.");
                }
                break;
            }
            case 'workload_not_found': {
                if (authenticated) {
                    messageHTML.push("The workload was not found or you are not permitted to view it.");
                } else {
                    messageHTML.push("You need to be logged in to view workloads.");
                }
                break;
            }
            case 'too_many_workloads': {
                messageHTML.push("Too many workloads are running on this server! Please try again later.");
                break;
            }
            case 'workload_running': {
                messageHTML.push("You already have a workload running.");
                break;
            }
            case 'internal_error': {
                messageHTML.push("An internal error occurred handling your request. Please try again or contact an administrator.");
                break;
            }
            default: {
                break;
            }
        }

        if (authenticated) {
            var authLink = window.document.getElementById("auth");
            authLink.setAttribute("href", "/logout");
            authLink.textContent = "Logout";
        } else {
            var uploadFile = window.document.getElementById("upload_file");
            var uploadSubmit = window.document.getElementById("upload_submit");
            uploadFile.setAttribute("style", "display: none");
            uploadSubmit.disabled = true;
            messageHTML.push('Please <a href="/login">Log in</a> with GitHub to submit Wasm workloads.');
        }

        if (messageHTML.length !== 0) {
            warningMessage.setAttribute("style", "");
            messageDiv.innerHTML = messageHTML.join("<br />")
        }

        httpGetAsync(
            "/config-template.toml",
            function (response) {
                var textarea = window.document.getElementsByTagName("textarea")[0];
                textarea.value = response;
            }
        );
    </script>

</body>

</html>
